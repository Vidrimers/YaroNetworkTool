#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
print_header() {
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}\n"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —É—Å–ø–µ—Ö–∞
print_success() {
    echo -e "${GREEN}‚úì $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–∫–∏
print_error() {
    echo -e "${RED}‚úó $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
print_warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
ask_confirmation() {
    while true; do
        read -p "$(echo -e ${YELLOW}"$1 (yes/no): "${NC})" yn
        case $yn in
            [Yy]* | [Yy][Ee][Ss]* ) return 0;;
            [Nn]* | [Nn][Oo]* ) return 1;;
            * ) echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ yes –∏–ª–∏ no.";;
        esac
    done
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root
if [ "$EUID" -ne 0 ]; then 
    print_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

print_header "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ X-Ray VPN —Å–µ—Ä–≤–µ—Ä–∞"
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç –ø–æ–ª–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫—É X-Ray Core"
echo "–í—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º"
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–æ–≤
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_DIR"
echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤: $SCRIPT_DIR"
echo ""

if ! ask_confirmation "–ù–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É?"; then
    print_warning "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 0
fi

# ============================================
# –®–ê–ì 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# ============================================
print_header "–®–ê–ì 1/7: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
echo "–ë—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: curl, wget, unzip, openssl, jq"
echo "–≠—Ç–∏ –ø–∞–∫–µ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã X-Ray –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
echo ""

if ask_confirmation "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏?"; then
    cd "$SCRIPT_DIR"
    chmod +x install-dependencies.sh
    if ./install-dependencies.sh; then
        print_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        exit 1
    fi
else
    print_warning "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============================================
# –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ X-Ray Core
# ============================================
print_header "–®–ê–ì 2/7: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ X-Ray Core"
echo "X-Ray Core - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç VPN —Å–µ—Ä–≤–µ—Ä–∞"
echo "–ë—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ /usr/local/bin/xray"
echo ""

if ask_confirmation "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å X-Ray Core?"; then
    cd "$SCRIPT_DIR"
    chmod +x install-xray.sh
    if ./install-xray.sh; then
        print_success "X-Ray Core —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        xray version
    else
        print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ X-Ray Core"
        exit 1
    fi
else
    print_warning "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============================================
# –®–ê–ì 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
# ============================================
print_header "–®–ê–ì 3/7: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –∏ UUID"
echo "–ë—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã:"
echo "  - UUID –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞"
echo "  - Private/Public –∫–ª—é—á–∏ –¥–ª—è Reality"
echo "  - Short ID"
echo "–ö–ª—é—á–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ generated/keys.txt"
echo ""

if ask_confirmation "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏?"; then
    cd "$SCRIPT_DIR"
    chmod +x generate-config.sh
    if ./generate-config.sh; then
        print_success "–ö–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã"
        echo ""
        print_warning "–í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–∏ –∫–ª—é—á–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!"
        if [ -f "$SCRIPT_DIR/generated/keys.txt" ]; then
            cat "$SCRIPT_DIR/generated/keys.txt"
        fi
    else
        print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π"
        exit 1
    fi
else
    print_warning "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============================================
# –®–ê–ì 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
# ============================================
print_header "–®–ê–ì 4/7: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
echo "–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è Reality"
echo "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ cert/cert.crt –∏ cert/secret.key"
echo ""

if ask_confirmation "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç?"; then
    cd "$PROJECT_DIR"
    chmod +x opensslcert
    mkdir -p cert
    cd cert
    if ../opensslcert; then
        print_success "SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
    else
        print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        exit 1
    fi
else
    print_warning "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============================================
# –®–ê–ì 5: –í—ã–±–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# ============================================
print_header "–®–ê–ì 5/7: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo "–î–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:"
echo "  1) VLESS Reality - –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–±—ã—Å—Ç—Ä–µ–µ, –ø—Ä–æ—â–µ)"
echo "  2) VLESS XHTTP CDN - —á–µ—Ä–µ–∑ Cloudflare (—Å–∫—Ä—ã–≤–∞–µ—Ç IP —Å–µ—Ä–≤–µ—Ä–∞)"
echo ""

CONFIG_FILE=""
while true; do
    read -p "$(echo -e ${YELLOW}"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (1 –∏–ª–∏ 2): "${NC})" config_choice
    case $config_choice in
        1)
            CONFIG_FILE="$PROJECT_DIR/configs/xray-vless-reality.json"
            print_success "–í—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: VLESS Reality"
            break
            ;;
        2)
            CONFIG_FILE="$PROJECT_DIR/configs/xray-vless-xhttp-cdn.json"
            print_success "–í—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: VLESS XHTTP CDN"
            print_warning "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Cloudflare –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏!"
            break
            ;;
        *)
            echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ 1 –∏–ª–∏ 2"
            ;;
    esac
done

echo ""
print_warning "–í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª:"
echo "  $CONFIG_FILE"
echo ""
echo "–ó–∞–º–µ–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:"
echo "  - YOUR_UUID_HERE –Ω–∞ –≤–∞—à UUID –∏–∑ generated/keys.txt"
echo "  - YOUR_PRIVATE_KEY_HERE –Ω–∞ –≤–∞—à Private Key"
echo "  - YOUR_SHORT_ID_HERE –Ω–∞ –≤–∞—à Short ID"
if [ "$config_choice" == "2" ]; then
    echo "  - your-domain.com –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω"
    echo "  - /your-path –Ω–∞ –∂–µ–ª–∞–µ–º—ã–π –ø—É—Ç—å"
fi
echo ""

if ! ask_confirmation "–í—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é?"; then
    print_warning "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
    print_warning "–ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –ø–æ–∑–∂–µ:"
    echo "  cd $SCRIPT_DIR"
    echo "  ./apply-config.sh $CONFIG_FILE"
    exit 0
fi

# ============================================
# –®–ê–ì 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞
# ============================================
print_header "–®–ê–ì 6/7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞"
echo "–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω systemd —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ X-Ray"
echo "–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã"
echo ""

if ask_confirmation "–°–æ–∑–¥–∞—Ç—å systemd —Å–µ—Ä–≤–∏—Å?"; then
    cd "$SCRIPT_DIR"
    chmod +x setup-systemd.sh
    if ./setup-systemd.sh; then
        print_success "Systemd —Å–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
    else
        print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ systemd —Å–µ—Ä–≤–∏—Å–∞"
        exit 1
    fi
else
    print_warning "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============================================
# –®–ê–ì 7: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# ============================================
print_header "–®–ê–ì 7/7: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ /usr/local/etc/xray/config.json"
echo "X-Ray —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω"
echo ""

if ask_confirmation "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å X-Ray?"; then
    cd "$SCRIPT_DIR"
    chmod +x apply-config.sh
    if ./apply-config.sh "$CONFIG_FILE"; then
        print_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞"
        print_success "X-Ray —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
    else
        print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        exit 1
    fi
else
    print_warning "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω"
fi

# ============================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ============================================
print_header "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å X-Ray:"
echo "  systemctl status xray"
echo ""
echo "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:"
echo "  journalctl -u xray -f"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "  1. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:"
echo "     cd $SCRIPT_DIR"
echo "     ./generate-client-link.sh"
echo ""
echo "  2. –î–æ–±–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç—ã:"
echo "     ./add-client.sh"
echo ""
echo "  3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)"
echo ""
print_success "–ì–æ—Ç–æ–≤–æ! –í–∞—à VPN —Å–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç üéâ"
